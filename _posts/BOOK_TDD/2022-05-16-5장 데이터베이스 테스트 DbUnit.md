---
title: 5장 데이터베이스 테스트 DbUnit
date: 2022-05-16 11:40:45 +0900
categories: [BOOK, TDD 실천법과 도구]
tags: [tdd]  # TAG는 반드시 소문자로 이루어져야함!
---

### 5.1 DbUnit의 장점
DB를 사용하는 부분은 프로그래밍 언어 외적인 부분이 상당 부분 포함되기 때문에 TDD를 적용하기가 종종 쉽지 않다. 이럴때 도움을 받을 수 있는 유틸리티로 DbUnit이 있다.

* 독립적인 데이터베이스 연결 지원
* 데이터베이스의 특정 시점 상태를 쉽게 내보내거나 읽어들일 수 있다.
* 테이블이나 데이터셋을 서로 쉽게 비교할 수 있다.

DbUnit은 독립적으로 사용하기보다는 JUnit 등의 테스트 프레임워크 등과 함께 사용한다. 따라서 테스트 프레임워크라기 보다는 테스트 지원 라이브러리에 더 가깝다.

### 5.2 데이터셋
데이터셋은 데이터베이스나 그 안에 존재하는 테이블 혹은 그 일부를 xml이나 csv 파일로 나타낸 모습이다.

예) SELLER table

| ID | NAME | EMAIL |
|----|------|-------|
|aaaa|김가가|aaa@naver.com|
|bbbb|고나나|bbb@hanmail.com|
|cccc|황다다|ccc@naver.com|
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<dataset>
  <seller ID="aaaa" NAME="김가가" EMAIL="aaa@naver.com"/>
  <seller ID="bbbb" NAME="고나나" EMAIL="bbb@hanmail.com"/>
  <seller ID="cccc" NAME="황다다" EMAIL="ccc@naver.com"/>
</dataset>
```
DbUnit은 이런 데이터셋의 형식을 이용해서 DB의 상태를 저장하거나 변경, 유지한다.

#### 데이터베이스 연결과 테이블 초기화
현재 가정한 데이터베이스 내의 데이터 내용이 변경된다면 기능 구현에 문제가 없음에도 불구하고 테스트 케이스가 실패할 수 있다. 따라서 현재 가정되어있는 DB안의 데이터 상태가 테스트를 수행하기 전에 가정했던 모습으로 한결같이 유지 됐으면 좋겠다.
그래서 테스트 관련 테이블 초기화 -> 테스트 케이스 수행 이라는 전략을 세웠다.

```
public class DatabaseRepositoryTest {
  //.....

  //1.DbUnit을 사용하기 위해서는 DbUnit에서 제공하는 DBTestCase를 상속하도록 작성한다.
  //상속하지 않고 DbUnit에서 제공하는 기능을 이용하려면 IDatabaseTester라는 인터페이스를 사용하면 된다.
  private IDatabaseTester databaseTester;

  @Before
  public void setUp() throws Exception {
    //2. IDatabaseTester 구현체로 JDBC 연결방식을 이용한다.
    databaseTester = new JdbcDatabaseTester(driver, protocol+dbName);
    try {
      //3. 데이터셋을 지정한다.
      IDataSet dataSet = new FlaxXmlDataSetBuilder().build(new File("seller.xml"));
      //4. DB커넥션과 데이터셋을 이용해 DB에 특정 작업을 수행한다.
      DatabaseOperation.CLEAN_INSERT.execute(databaseTester.getConnection(), dataSet);
    }finally {
      databaseTester.getConnection().close();
    }
  }
}
```
위 setUp() 메소드는 테스트 메소드가 수행되기 전에 항상 seller.xml에 지정된 상태로 테이블을 초기화한다.

#### 데이터셋 비교
```
//1. 현재 데이터베이스의 상태를 데이터 셋으로 추출한다.
IDataSet currentDBdataSet = databaseTester.getConnection().createDataSet();

//2. 데이터셋에서 특정 테이블을 가져온다.
ITable actualTable = currentDBdataSet.getTable("seller");

//3.미리 만들어놓은 예상 데이터셋을 읽어들인다.
IDataSet expectedDataSet = new FlaxXmlDataSetBuilder().build(new File("expected_seller.xml"));

//4. 예상 데이터셋 중에서 비교에 사용할 테이블을 읽어들인다.
ITable expectedTable = expectedDataSet.getTable("seller");

//5. DbUnit에서 제공하는 Assertion 클래스의 메소드를 이용해 결과를 비교한다.
Assert.assertEquals(expectedTable, actualTable);
```
