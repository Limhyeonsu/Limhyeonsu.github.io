---
title: 17. 스프링데이터 JPA 소개
date: 2023-01-22 21:58:21 +0900
categories: [BOOK, JPA 프로그래밍 입문]
tags: [jpa, sql]  # TAG는 반드시 소문자로 이루어져야함!
---

## 01. 중복 코드
```java
@Repository
public class UserRepository{
  @PersistenceContext
  private EntityManager;

  public User find(String email) {
    return em.find(User.class, email);
  }

  public void save(User user) {
    em.persist(user);
  }

  //...
}

@Repository
public class HotelRepository{
  @PersistenceContext
  private EntityManager;

  public Hotel find(String id) {
    return em.find(Hotel.class, id);
  }

  public void save(Hotel hotel) {
    em.persist(hotel);
  }

  //...
}
```

UserRepository와 HotelRepository는 다루는 엔티티만 다를 뿐 EntityManager를 이용해서 엔티티를 찾고, 저장하는 코드는 온전히 동일한 구조를 갖는다.

이런 중복 코드 작업을 없앨 수 있는 좋은 방법이 있는데, 그것이 바로 스프링 데이터 JPA를 사용하는 것이다.

## 02. 스프링 데이터 JPA 소개
스프링 데이터 JPA를 이용해서 많은 중복 코드 작성을 줄일 수 있다.

```java
public interface UserRepositoty extends Repository<User, String> {
  User findOne(String email);
  User save(User user);
  void delete(User user);

  @Query("select u from User u order by u.name")
  List<User> findAll();
}
```
Repository는 스프링 데이터 JPA가 제공하는 인터페이스이다. 이 인터페이스만 상속받아 정해진 규칙에 맞게 메서드를 작성하면 된다. 따라서 EntityManager를 이용한 코드를 중복해서 구현할 필요가 없다.

스프링 데이터 JPA는 Repository를 상속한 인터페이스를 검색하고, 그 인터페이스를 알맞게 구현한 객체를 스프링 빈으로 등록한다.

```java
//UserRepositoty를 사용할 코드는 다음 처럼 의존성 주입을 통해 UserRepositoty 빈을 주입받아 사용한다.
@Service
public class UserService {
  @Autowired
  public void setUserRepositoty(UserRepositoty userRepositoty) {
    this.userRepositoty = userRepositoty;
  }
}
```

## 03. 스프링 데이터 JPA 설정
스프링 데이터 JPA를 사용하려면 프로젝트에 spring-data-jpa 모듈에 대한 의존을 추가하면 된다. (369~372p)

## 04. 리포지토리 인터페이스 메서드 작성 규칙
### 4-1. 리포지토리 인터페이스 작성
스프링 데이터 JPA를 위한 리포지토리 인터페이스를 작성하는 것이 첫 번째다. 스프링 데이터 JPA는 spring-data-jpa, spring-data-common 모듈을 사용하는데 이 두 모듈이 제공하는 리포지토리 타입 중 하나를 상속받은 인터페이스를 작성하면 된다.

```java
//T는 엔티티 타입을 의미하고, ID는 식별자 타입을 의미한다.
public interface Repository<T, ID extends Serializable> {
}

public interface UserRepositoty extends Repository<User, String> {...}

//Repository 인터페이스를 상속 받는 대신 애노테이션을 사용해도 된다.
@RepositoryDefinition(domainClass=Hotel.class, idClass = String.class)
public interface HotelRepository {...}
```
### 4-2. 기본 메서드
```java
public interface UserRepository extends Repository<User, String> {
  //식별자를 인자로 받는다.
  User findOne(String email);
  //save 메서드는 해당 엔티티의 상태에 따라 persist()나 merge()를 사용해서 엔티티를 저장한다.
  User save(User user);
  void delete(User user);
}
```

스프링 데이터 JPA는 새로운 엔티티인지 여부를 판단할 때 다음과 같은 규칙을 사용한다.
* 해당 엔티티 클래스가 Persistable 인터페이스를 구현했다면 isNew() 메서드로 새로운 엔티티인지 검사한다.
* 엔티티에 @Version 속성이 있다면 버전 속성이 null인 경우 새 엔티티로 간주한다.
* 식별자가 기본 데이터 타입이 아니면 식별자가 null인 경우 새 엔티티로 간주한다. 숫자 타입이면 값이 0인 경우 새 엔티티로 간주힌디.
