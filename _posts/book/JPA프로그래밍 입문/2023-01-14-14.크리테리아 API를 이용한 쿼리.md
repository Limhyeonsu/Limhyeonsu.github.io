---
title: 14. 크리테리아 API를 이용한 쿼리
date: 2023-01-14 23:20:50 +0900
categories: [BOOK, JPA 프로그래밍 입문]
tags: [sql]  # TAG는 반드시 소문자로 이루어져야함!
---

## 01. 크리테리아 API
크리테리아 API는 자바 코드를 이용해서 작성하는 쿼리이다.
```java
CritetiaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<User> cq = cb.createQuery(User.class);
Root<User> root = cq.from(User.class);
cq.select(root);
cq.where(cb.equal(root.get("name"), "고길동");

TypedQuert<User> query = em.createQuery(cq);
List<User> users = query.getResultLiat();
```
JPQL보다 복잡하지만 사용하는 이유는 크리테리아가 가진 장점이 있기 때문이다.
1. 다양한 조건을 조합하기 쉽다.
2. 문자열과 달리 자바 코드를 사용하기 때문에 타입에 안전한 쿼리를 만들 수 있다.
3. 자바 코드이기 때문에 IDE의 코드 자동 완성 기능을 활용할 수 있다.

## 02. 크리테리아 기본 코드
```java
//1) EntityManager에서 CritetiaBuilder 구한다.
CritetiaBuilder cb = em.getCriteriaBuilder();

//2) User 타입의 CriteriaQuery 생성 => createQuery 메서드의 인자는 조회 결과 타입을 지정
CriteriaQuery<User> cq = cb.createQuery(User.class);

//3) from User
Root<User> root = cq.from(User.class);

//4) root를 조회 결과로 사용 => select root from User root
cq.select(root);

//5) CriteriaQuery로부터 Query 생성
TypedQuert<User> query = em.createQuery(cq);
```

## 03. 검색 조건 지정
```java
//CritetiaBuilder는 Predicate를 생성하는 메서드를 제공한다. => cb.equal(비교할 대상, 비교할 값)
Predicate namePredicate = cb.equal(root.get("name")."고길동");
cq.where(namePredicate);
```

## 04. 속성 경로 구하기
root.get("name")은 User 엔티티의 name 속성에 해당하는 Path 객체를 구한다. Path 인터페이스는 엔티티나 밸류, 콜렉션 등의 속성의 경로를 표현한다.

```java
public interface Path<X> extends Expression<X> {...}

//타입 파라미터 X는 Path 인터페이스가 나타내는 대상 속성의 타입이다. 따라서 다음과 같이 속성 타입을 지정해서 Path를 수할 수 있다.
Path<Stirng> name = root.get("name");
```

이름 대신에 정적 메타모델을 사용해서 속성을 지정할 수도 있다. 정적 메타모델은 엔티티의 속성에 대한 메타 정보를 담고 있는 클래스로서 다음과 같이 생겼다.
```java
@StaticMetamodel(User.class)
public class User_ {
  public static SingularAttribute<User, String> email;
  public static SingularAttribute<User, String> name;

  //...
}

//정적 메타모델을 사용하면 속성 경ㅇ로를 구할 때 정적 메타모델의 필드를 사용할 수 있다.
Predicate namePredicate = cb.equal(root.get(User_.name), "고길동");
```
정적 메타모델을 사용하면 타입이나 이름을 오류 없이 알맞은 Path 타입으로 구할 수 있기 때문에 컴파일 시점에 타입에 안전한 코드를 작성할 수 있다는 장점이 있다.

### 4-1. 중첩 속성 경로 구하기
1:1 연관관계를 맺고 있는 경우 연관된 엔티티의 속성을 검색조건으로 사용해서 검색하고 싶은 경우 중첩해서 속성을 구하면 된다.
```java
Predicate namePredicate = cb.equal(root.get("user").get("name"), "고길동");
```

## 05. CriteriaQuery와 CriteriaBuilder 구분
* CriteriaQuery - select, from, where, groupBy, having, order by 등 쿼리의 절을 생성
* CriteriaBuilder - 각 절의 구성 요소를 생성

CriteriaBuilder는 where 절에서 사용할 Preidcate 구성 요소를 생성하거나, 정렬 순서를 표현하는 Order 구성요소를 생성할 때 등에 사용할 수 있다.
