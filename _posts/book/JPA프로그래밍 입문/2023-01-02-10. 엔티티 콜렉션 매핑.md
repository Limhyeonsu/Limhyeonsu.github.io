---
title: 10. 엔티티 콜렉션 매핑
date: 2023-01-02 20:33:23 +0900
categories: [BOOK, JPA 프로그래밍 입문]
tags: [sql]  # TAG는 반드시 소문자로 이루어져야함!
---

## 01. 엔티티 콜렉션 매핑과 연관 관리
엔티티 콜렉션 매핑은 코드를 복잡하게 만들고, 얻을 수 있는 장점은 크지 않다. 게다가 잘못 사용하면 성능에 영향까지 줄 수 있다. 하지만 콜렉션 매핑이 필요한 순간이 있기 때문에 어떻게 설정해야하는지 알 필요가 있다.

예) 스포츠 팀과 소속 선수와의 관계

```java
public class Team{
    private Set<Player> players = new HashSet<>();

    public void addPlayer(player p){
        this.players.add(p);
    }
}
```

```java
//Team에서 Player로의 1:N 연관이 단방향인 경우 Player의 팀을 옮기는 코드
Team team1 = new Team("팀1");
Team team2 = new Team("팀2");
Player player1 = new Player("선수1");
team1.removePlayer(player1);
team2.addPlayer(player1);
```

```java
//Player에서 Team으로의 연관이 필요한 경우
public class Player{
    private Team team;

    //...
}
```

```java
Team team1 = findTeam("팀1");
Team team2 = findTeam("팀2");
Player player1 = findPlayer("선수1");

team1.removePlayer(player1);

//양방향인 경우 관련된 엔티티의 연관을 알맞게 처리해야 한다.
player1.setTeam(team2);
team2.addPlayer(player1);
```

```java
//양방향 연관을 addPlayer()에서 관리하도록 구현할 수 있다.
public class Team{
    private Set<Player> players = new HashSet<>();

    public void addPlayer(Player player) {
        Team current = player.getTeam();
        if(current == this) return;
        //player가 속한 현재 팀에서 제거
        if(current != null) {
            current.remove(player);
        }
        //새로운 팀으로 변경
        this.players.add(player);
        player.setTeam(this);
    }
}

Team team2 = new Team("탐2");
Player player1 = new Player("선수1");
team2.addPlayer(player1);
```

M:N 연관은 1:N 연관과 유사하지만 조금 더 복잡하다. 대표적인 예로 상품과 카테고리가 있다.
```java
public class Product {
    private Set<Category> categories;
    //...

    public void changeCategory(Set<Category> newCategories) {
        for(Category cat : this.categories) {
            if(!newCategories.contains(cat)) {
                //기존 카테고리가 변경할 카테고리에 속하지 않으면 기존 카테고리에서 상품으로의 연관 제거
                cat.removeProduct(this);
            }
        }
        //변경할 카테고리에 제품 연관 추가
        for(category nawCat : newCategories) {
            newCat.add(this);
        }
        //카테고리에 대한 연관 변경
        this.categories = newCategories;
    }
}

public class Category {
    private Set<Product> products;
    //...
}
```

## 02. 1:N 단방향 엔티티 Set 매핑
```java
//Team 엔티티에서 Player 엔티티로의 1:N 단방향 연관설정
@Entity
public class Team {
    @Id
    private String id;
    private String name;

    @OneToMany
    @JoinColumn(name="team_id")
    priavate Set<Player> players = new HashSet<>();

    //….
}

@Entity
public class Player{
    @Id
    @Column(name="player_id")
    private String id;
    private String name;

    //….
    //equals, hashcode
}
```
Player 엔티티는 Set에 저장되므로 equals() 메서드와 hashCode() 메서드를 구현했다.
