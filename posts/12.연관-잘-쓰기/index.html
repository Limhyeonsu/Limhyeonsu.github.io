<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="연관 잘 쓰기" /><meta property="og:locale" content="en" /><meta name="description" content="01. 연관의 복잡성 1.1 로딩 설정의 어려움 ```java Order order = em.find(Order.class, orderId); List orderLines = order.getOrderLines(); for(OrderLine ol: orderLines) { Content content = ol.getProduct().getContent(); System.out.println(content.getTitle() + &quot;&quot; + content.getCast()); }" /><meta property="og:description" content="01. 연관의 복잡성 1.1 로딩 설정의 어려움 ```java Order order = em.find(Order.class, orderId); List orderLines = order.getOrderLines(); for(OrderLine ol: orderLines) { Content content = ol.getProduct().getContent(); System.out.println(content.getTitle() + &quot;&quot; + content.getCast()); }" /><link rel="canonical" href="https://limhyeonsu.github.io/posts/12.%EC%97%B0%EA%B4%80-%EC%9E%98-%EC%93%B0%EA%B8%B0/" /><meta property="og:url" content="https://limhyeonsu.github.io/posts/12.%EC%97%B0%EA%B4%80-%EC%9E%98-%EC%93%B0%EA%B8%B0/" /><meta property="og:site_name" content="Hyeonsu Lim" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-05T20:24:23+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="연관 잘 쓰기" /><meta name="twitter:site" content="@imhyeon99494867" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-20T00:22:25+09:00","datePublished":"2023-01-05T20:24:23+09:00","description":"01. 연관의 복잡성 1.1 로딩 설정의 어려움 ```java Order order = em.find(Order.class, orderId); List orderLines = order.getOrderLines(); for(OrderLine ol: orderLines) { Content content = ol.getProduct().getContent(); System.out.println(content.getTitle() + &quot;&quot; + content.getCast()); }","headline":"연관 잘 쓰기","mainEntityOfPage":{"@type":"WebPage","@id":"https://limhyeonsu.github.io/posts/12.%EC%97%B0%EA%B4%80-%EC%9E%98-%EC%93%B0%EA%B8%B0/"},"url":"https://limhyeonsu.github.io/posts/12.%EC%97%B0%EA%B4%80-%EC%9E%98-%EC%93%B0%EA%B8%B0/"}</script><title>12. 연관 잘 쓰기 | Hyeonsu Lim</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hyeonsu Lim"><meta name="application-name" content="Hyeonsu Lim"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/profile_img.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hyeonsu Lim</a></div><div class="site-subtitle font-italic">Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Limhyeonsu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/imhyeon99494867" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['gustn72096','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>12. 연관 잘 쓰기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>12. 연관 잘 쓰기</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/imhyeon99494867">Lim Hyeonsu</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1672917863" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-01-05 </em> </span> <span> Updated <em class="timeago" data-ts="1674141745" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-01-20 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2278 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><h2 id="01-연관의-복잡성"><span class="mr-2">01. 연관의 복잡성</span><a href="#01-연관의-복잡성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="11-로딩-설정의-어려움"><span class="mr-2">1.1 로딩 설정의 어려움</span><a href="#11-로딩-설정의-어려움" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">orderId</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderLines</span><span class="o">();</span>
<span class="k">for</span><span class="o">(</span><span class="nc">OrderLine</span> <span class="nl">ol:</span> <span class="n">orderLines</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Content</span> <span class="n">content</span> <span class="o">=</span> <span class="n">ol</span><span class="o">.</span><span class="na">getProduct</span><span class="o">().</span><span class="na">getContent</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">getTitle</span><span class="o">()</span> <span class="o">+</span> <span class="s">""</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="na">getCast</span><span class="o">());</span>
<span class="o">}</span>

</pre></table></code></div></div><p>위 코드는 Order 엔티티에서 시작해서 OrderLine, Product, Content를 접근하고 있다. 모든 연관을 즉시 로딩으로 설정했다면 Order를 로딩하는 시점에 OrderLine, Product, Content를 로딩하기 위한 쿼리도 함께 실행할 것이다. 그렇다고 해서 지연 로딩과 즉시 로딩을 적절하게 섞어 쓰기도 쉽지 않다. 상황에 따라 필요한 연관 객체가 다를 수 있어 특정 연관을 지연 로딩이나 즉시 로딩으로 한정할 수 없다.</p><h3 id="12-편리한-객체-탐색과-높은-결합도"><span class="mr-2">1.2 편리한 객체 탐색과 높은 결합도</span><a href="#12-편리한-객체-탐색과-높은-결합도" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>모든 엔티티를 연관으로 연결하면 객체 탐색을 통해 쉽게 원하는 객체에 접근할 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">//객체들이 연관으로 연결되어 있으면 연관된 객체의 데이터를 쉽게 변경할 수 있다.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">User</span> <span class="n">orderer</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changeShippingAddress</span><span class="o">(</span><span class="nc">Address</span> <span class="n">newShippingAddress</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">useUserAddress</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">shippingAddress</span> <span class="o">=</span> <span class="n">newShippingAddress</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">useUserAddress</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//연관된 User 데이터를 변경</span>
      <span class="n">orderer</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">newShippingAddress</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이렇게 한 엔티티에서 다른 엔티티의 상태를 변경하는 기능을 실행하면 엔티티가 서로 강하게 엮이게 되면서 서로 수정을 어렵게 만드는 원인이 될 수 있다.</p><h2 id="02-연관-범위-한정과-식별자를-통한-간접-참조"><span class="mr-2">02. 연관 범위 한정과 식별자를 통한 간접 참조</span><a href="#02-연관-범위-한정과-식별자를-통한-간접-참조" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>엔티티 간의 참조가 많아질수록 한 엔티티의 기능을 변경할 때 여러 엔티티를 함께 수정해야 할 가능성이 커진다. 이는 코드 변경을 어렵게 만드는 원인이 될 수 있다. 그러기 위해 다음의 방법을 적용한다.</p><ul><li>연관 범위를 도메인을 기준으로 한정<li>도메인을 넘어서는 엔티티 간에는 식별자를 이용한 간접 참조</ul><p><img data-src="/assets/img/posting_img/book/JPA%20프로그래밍%20입문/연관을정리한구조.jpeg" width="700px" data-proofer-ignore></p><p>위 그림을 보면 특정 영역 안에서는 연관을 이용해 직접 참조를 유지했지만, 영역을 벗어나는 관계에 대해서는 식별자를 이용해서 간접적으로 참조했다.</p><p>식별자를 통한 간접 참조 방식을 사용하면 식별자로 연관된 엔티티를 검색하는 과정이 추가되기 때문에 다소 코드가 길어진다. 하지만 앞선 로딩 설정의 어려움과 엔티티 간의 결합도 증가를 완화할 수 있다.</p><h2 id="03-상태-변경-관련-기능과-조회-관련-기능"><span class="mr-2">03. 상태 변경 관련 기능과 조회 관련 기능</span><a href="#03-상태-변경-관련-기능과-조회-관련-기능" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>연관을 한정해서 사용하면 설정이나 코드 복잡도가 줄어드는 장점이 있다. 하지만 데이터 조회시 여러 엔티티를 직접 조회해야 하는 불편함도 있다. 이런 불편함을 해결하는 방법으로 상태를 변경하는 기능과 조회하는 기능을 분래해서 생각하는 것이다.</p><p>데이터를 새로 생성하거나 수정하거나 삭제하는 상태 변경 기능은 한두 개의 엔티티만 로딩하기 때문에 식별자로 연관된 엔티티를 직접 로딩해야하는 불편함이 크지 않다.</p><p>조회 관련 기느은 한 개 이상의 엔티티를 함께 조회하는 경우가 많다. 이렇게 여러 엔티티의 데이터를 조합해야 하는 조회 기능은 조회 기능애 맞는 모델을 따로 구현하는 것을 고려해보자</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">//예) 주문 목록 &gt; Order + OrderLine + Product</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderSummary</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">ordererName</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Timestamp</span> <span class="n">orderDate</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">totalAmounts</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstProductName</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstProductId</span><span class="o">;</span>

  <span class="c1">//...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>도메인이 커질수록 한 개의 모델로 상태 변경 기능과 조회 기능을 구현하기 어려워진다. 로딩 방식의 문제뿐 아니라 상태 변경 시점과 조회 시점에 필요한 데이터가 다르기 때문이다.</p><p>조회 시점에 필요한 데이터와 변경 시점에 다루는 데이터의 차이가 클수록 조회 전용 모델을 별도로 만들 것을 고려해 봐야 한다.</p><h2 id="04-식별자를-공유하는-11-연관이-엔티티와-밸류-관계인지-확인"><span class="mr-2">04. 식별자를 공유하는 1:1 연관이 엔티티와 밸류 관계인지 확인</span><a href="#04-식별자를-공유하는-11-연관이-엔티티와-밸류-관계인지-확인" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>모든 테이블을 엔티티로 매핑하는 것은 모델의 의미를 약화시킬 수 있다. 한 도메인 영역세 속하면서 식별자 공유 방식으로 1:1 연관을 맺는 두 엔티티가 동일한 라이프사이클을 갖게 된다. 그렇게 되면 이 관계는 두 엔티티의 1:1 연관이 아닌 엔티티와 밸류 관계일 가능성이 크다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c1">//1:1 연관</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Appeal</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

  <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mapperdBy</span><span class="o">=</span><span class="s">"appeal"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">AppealStatus</span> <span class="n">status</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"appeal_atatus"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppealStatus</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="n">priavate</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

  <span class="nd">@OneToOne</span>
  <span class="nd">@primaryKeyColumn</span>
  <span class="n">priavate</span> <span class="nc">Appeal</span> <span class="n">appeal</span><span class="o">;</span>

  <span class="c1">//...</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">//엔티티-밸류 관계</span>
<span class="nd">@Entity</span>
<span class="nc">SecondaryTable</span><span class="o">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s">"appeal_status"</span><span class="o">,</span>
  <span class="n">pkJoinColumns</span><span class="o">=</span><span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"id"</span><span class="o">,</span>
        <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"id"</span><span class="o">)</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Appeal</span><span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

  <span class="nd">@Embedded</span>
  <span class="kd">private</span> <span class="nc">AppealStatus</span> <span class="n">status</span><span class="o">;</span>
  <span class="c1">//...</span>
<span class="o">}</span>

<span class="nd">@Embeddedable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppealStatus</span><span class="o">{</span>
  <span class="c1">//...</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="05-엔티티-콜렉션-연관과-주의-사항"><span class="mr-2">05. 엔티티 콜렉션 연관과 주의 사항</span><a href="#05-엔티티-콜렉션-연관과-주의-사항" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="5-1-1n-연관보다-n1-연관-우선"><span class="mr-2">5-1. 1:N 연관보다 N:1 연관 우선</span><a href="#5-1-1n-연관보다-n1-연관-우선" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>1:N 연관을 사용할 때 주의할 점은 N에 해당하는 부분을 실제 기능에서 어떤 식으로 사용하는지 알아야 한다는 점이다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hotel</span> <span class="o">{</span>
  <span class="c1">//...</span>

  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Review</span><span class="o">&gt;</span> <span class="nf">getLatestReview</span><span class="o">(</span><span class="kt">int</span> <span class="n">cnt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">reviews</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">limit</span><span class="o">(</span><span class="n">cnt</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>위 예에서 최근 리뷰 n개를 제공하는 메서드를 제공한다. 그런데 이 코드에서 호텔과 관련된 리뷰의 개수가 만 개면 reviews는 만 개의 review 객체를 갖게 된다. 필요한 것은 최근에 등록한 n개지만, 만 개를 로딩하게 된다. 따라서 Hotel과 연관된 Review가 많을수록 이 기능은 실행 속도가 느려져서 성능에 문제를 일으킨다.</p><p><code class="language-plaintext highlighter-rouge">1:N연관에서 콜렉션에 보관된 엔티티를 일부만 사용하는 기능이 있다면 1:N 연관을 사용하면 안 된다. 대신 N:1 연관을 사용해야 한다.</code> N:1 연관을 사용하면 코드는 다소 길어지지만 1:N 연관을 사용할 때 발생하는 성능 관련 문제를 해결할 수 있다.</p><h3 id="5-2-엔티티-간-1n-연관과-밸류-콜렉션"><span class="mr-2">5-2. 엔티티 간 1:N 연관과 밸류 콜렉션</span><a href="#5-2-엔티티-간-1n-연관과-밸류-콜렉션" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>엔티티간 1:N 연관으로 보이는 것 중에 실제로는 밸류에 대한 콜렉션 연관인 경우도 있다. 처음 JPA를 사용할 때 자주 접하는 실수는 모든 테이블에 대해 엔티티 클래스를 작성하는 것이다.</p><p>대표적인 예가 주문과 개별 주문 항목이다. 이 때 주문과 개별 주문 항목은 각각 별도 테이블과 매핑되나 개별 주문 항목은 자신만의 식별자를 갖는 엔티티라기 보다는 주문에 포함된 밸류이다. 따라고 이 둘은 1:N 관계가 아니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span><span class="o">{</span>
  <span class="nd">@ElementCollection</span>
  <span class="nd">@CollectionTable</span><span class="o">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">"order_line"</span><span class="o">,</span>
    <span class="n">joinColumns</span><span class="o">=</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"order_id"</span><span class="o">)</span>
  <span class="nd">@OrderColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"idx"</span><span class="o">))</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
  <span class="c1">//...</span>
<span class="o">}</span>

<span class="nd">@Embeddedable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderLine</span> <span class="o">{</span>
  <span class="c1">//...</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">단순히 테이블이 따로 존재한다고 해서 엔티티 간의 1:N 연관으로 매핑하는 것은 옳지 않다.</code> 1:N 연관이 필요하다면 해당 연관이 엔티티 간의 연관인지 밸류 콜렉션인지 검토 해야 한다. 한 도메인 영역에 속하면서 <strong>1:N 연관을 맺는 엔티티가 동일한 라이프 사이클을 갖는다면</strong> 엔티티 콜렉션이 아닌 밸류 콜렉션이 더 적합하지 않은지 확인하도록 하자</p><h3 id="5-3-mn-연관-대체하기--연관-엔티티-사용"><span class="mr-2">5-3. M:N 연관 대체하기 : 연관 엔티티 사용</span><a href="#5-3-mn-연관-대체하기--연관-엔티티-사용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>단방향 연관이든 양방향 연관이든 M:N 연관은 구현을 복잡하게 만들기 때문에 최대한 피하는 게 좋다. M:N 연관 엔티티를 사용하는 방법은 조인 테이블을 엔티티로 매핑하는 것이다. 이 방법은 코드가 복잡해지는 것보다 나은 선택이다.</p><p><img data-src="/assets/img/posting_img/book/JPA%20프로그래밍%20입문/M대N연관대체.jpeg" width="700px" data-proofer-ignore></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">//CastMap 클래스의 식별자로 사용하기 위한 castMapId 클래스</span>
<span class="nd">@Embeddedable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CastMapId</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"performace_id"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">performanceId</span><span class="o">;</span>

  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"person_id"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">personId</span><span class="o">;</span>

  <span class="c1">//생성자, getter, equals, hashCode()...</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"perf_person"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CastMap</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="kd">private</span> <span class="nc">CastMapId</span> <span class="n">id</span><span class="o">;</span>

  <span class="nd">@ManyToOne</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"performance_id"</span><span class="o">,</span> <span class="n">insetable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">Performance</span> <span class="n">performance</span><span class="o">;</span>

  <span class="nd">@ManyToOne</span>
  <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"person_id"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">Person</span> <span class="n">person</span><span class="o">;</span>

  <span class="c1">//생성자, getter...</span>
<span class="o">}</span>

</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>

<span class="nc">Performance</span> <span class="n">perf</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Performance</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"PF002"</span><span class="o">);</span>
<span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"P05"</span><span class="o">);</span>
<span class="nc">CastMap</span> <span class="n">castMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CastMap</span><span class="o">(</span><span class="n">perf</span><span class="o">,</span> <span class="n">person</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">castMap</span><span class="o">);</span>

<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/book/'>BOOK</a>, <a href='/categories/jpa-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EC%9E%85%EB%AC%B8/'>JPA 프로그래밍 입문</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/jpa/" class="post-tag no-text-decoration" >jpa</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >sql</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=12.+%EC%97%B0%EA%B4%80+%EC%9E%98+%EC%93%B0%EA%B8%B0+-+Hyeonsu+Lim&url=https%3A%2F%2Flimhyeonsu.github.io%2Fposts%2F12.%25EC%2597%25B0%25EA%25B4%2580-%25EC%259E%2598-%25EC%2593%25B0%25EA%25B8%25B0%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=12.+%EC%97%B0%EA%B4%80+%EC%9E%98+%EC%93%B0%EA%B8%B0+-+Hyeonsu+Lim&u=https%3A%2F%2Flimhyeonsu.github.io%2Fposts%2F12.%25EC%2597%25B0%25EA%25B4%2580-%25EC%259E%2598-%25EC%2593%25B0%25EA%25B8%25B0%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Flimhyeonsu.github.io%2Fposts%2F12.%25EC%2597%25B0%25EA%25B4%2580-%25EC%259E%2598-%25EC%2593%25B0%25EA%25B8%25B0%2F&text=12.+%EC%97%B0%EA%B4%80+%EC%9E%98+%EC%93%B0%EA%B8%B0+-+Hyeonsu+Lim" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div><script src="https://utteranc.es/client.js" repo="Limhyeonsu/Limhyeonsu.github.io" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/15.Top-N%EC%BF%BC%EB%A6%AC/">15. Top-N 쿼리</a><li><a href="/posts/09.%EB%A9%B4%EC%A0%91%EB%AC%B8%EC%A0%9C/">09. 면접문제</a><li><a href="/posts/14.%EB%B6%84%EC%84%9D%ED%95%A8%EC%88%98/">14. 분석함수</a><li><a href="/posts/07.%EA%B8%B0%EC%88%A0%EC%A0%81-%EB%AC%B8%EC%A0%9C/">07. 기술적 문제</a><li><a href="/posts/06.bigO/">06. big-O</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/software-engineering/">software_engineering</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/computer/">computer</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/http/">http</a> <a class="post-tag" href="/tags/infra/">infra</a> <a class="post-tag" href="/tags/tdd/">tdd</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/bufferedreader/">bufferedreader</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/02.JPA-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/"><div class="card-body"> <em class="timeago small" data-ts="1671108218" > 2022-12-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2. JPA 시작하기</h3><div class="text-muted small"><p> 01. 예제 프로젝트 02. 메이븐 프로젝트 생성 및 이클립스 임포트 03. 데이터베이스 생성 04. 모델 클래스와 매핑 설정 @Entity //1) @Table(name=&quot;user&quot;) //2) public class User { @Id //3) private String email; private String name; //4...</p></div></div></a></div><div class="card"> <a href="/posts/03.%EC%97%94%ED%8B%B0%ED%8B%B0/"><div class="card-body"> <em class="timeago small" data-ts="1671352838" > 2022-12-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>3. 엔티티</h3><div class="text-muted small"><p> 01. 엔티티 클래스 JPA에서 엔티티는 영속성을 가진 객체로서 가장 중요한 타입이다. JPA의 엔티티는 DB 테이블에 보관할 대상이 된다. EntityManager를 사용해서 엔티티 단위로 저장하고 조회하고 삭제한다. JPA는 두 가지 방법으로 엔티티를 설정하는데 1)@Entity 애노테이션을 사용하는 방법 2)XML 매핑 설정을 사용하는 방법이 ...</p></div></div></a></div><div class="card"> <a href="/posts/04.%EB%B0%B8%EB%A5%98%EC%99%80-@Embeddable/"><div class="card-body"> <em class="timeago small" data-ts="1671631332" > 2022-12-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>4. 밸류와 @Embeddable</h3><div class="text-muted small"><p> 01. 밸류로 의미 더 드러내기 Hotel 클래스는 주소 자체를 의미하는 address 데이터를 갖고 있다. 그리고 Address 클래스는 zipcode, address1, address2를 데이터로 갖고 있어 따로 유추하지 않아도 주소가 우편번호, 주소1, 주소2로 구성된다는 것을 알 수 있다. Address 클래스 같은 타입을 value라고 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/11.%EC%98%81%EC%86%8D%EC%84%B1-%EC%A0%84%EC%9D%B4/" class="btn btn-outline-primary" prompt="Older"><p>11. 영속성 전이</p></a> <a href="/posts/13.JPQL/" class="btn btn-outline-primary" prompt="Newer"><p>13. JPQL</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/imhyeon99494867">Lim Hyeonsu</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/software-engineering/">software_engineering</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/computer/">computer</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/http/">http</a> <a class="post-tag" href="/tags/infra/">infra</a> <a class="post-tag" href="/tags/tdd/">tdd</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/bufferedreader/">bufferedreader</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
