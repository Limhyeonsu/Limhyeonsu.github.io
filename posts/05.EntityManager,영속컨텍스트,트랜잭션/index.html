<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="EntityManager, 영속 컨텍스트, 트랜잭션" /><meta property="og:locale" content="en" /><meta name="description" content="01. EntityManager와 영속 컨텍스트 ```java EntityManager entityManager = emf.createEntityManager(); EntityTransaction transaction = entityManager.getTransaction();" /><meta property="og:description" content="01. EntityManager와 영속 컨텍스트 ```java EntityManager entityManager = emf.createEntityManager(); EntityTransaction transaction = entityManager.getTransaction();" /><link rel="canonical" href="https://limhyeonsu.github.io/posts/05.EntityManager,%EC%98%81%EC%86%8D%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8,%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98/" /><meta property="og:url" content="https://limhyeonsu.github.io/posts/05.EntityManager,%EC%98%81%EC%86%8D%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8,%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98/" /><meta property="og:site_name" content="Hyeonsu Lim" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-24T20:08:38+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="EntityManager, 영속 컨텍스트, 트랜잭션" /><meta name="twitter:site" content="@imhyeon99494867" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-20T00:22:25+09:00","datePublished":"2022-12-24T20:08:38+09:00","description":"01. EntityManager와 영속 컨텍스트 ```java EntityManager entityManager = emf.createEntityManager(); EntityTransaction transaction = entityManager.getTransaction();","headline":"EntityManager, 영속 컨텍스트, 트랜잭션","mainEntityOfPage":{"@type":"WebPage","@id":"https://limhyeonsu.github.io/posts/05.EntityManager,%EC%98%81%EC%86%8D%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8,%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98/"},"url":"https://limhyeonsu.github.io/posts/05.EntityManager,%EC%98%81%EC%86%8D%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8,%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98/"}</script><title>5. EntityManager, 영속 컨텍스트, 트랜잭션 | Hyeonsu Lim</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hyeonsu Lim"><meta name="application-name" content="Hyeonsu Lim"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/profile_img.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hyeonsu Lim</a></div><div class="site-subtitle font-italic">Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Limhyeonsu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/imhyeon99494867" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['gustn72096','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>5. EntityManager, 영속 컨텍스트, 트랜잭션</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>5. EntityManager, 영속 컨텍스트, 트랜잭션</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/imhyeon99494867">Lim Hyeonsu</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1671880118" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-12-24 </em> </span> <span> Updated <em class="timeago" data-ts="1674141745" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-01-20 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2011 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h2 id="01-entitymanager와-영속-컨텍스트"><span class="mr-2">01. EntityManager와 영속 컨텍스트</span><a href="#01-entitymanager와-영속-컨텍스트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nc">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="nc">EntityTransaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>

<span class="k">try</span><span class="o">{</span>
  <span class="n">transaction</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
  <span class="nc">Sight</span> <span class="n">sight</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Sight</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1L</span><span class="o">);</span>
  <span class="n">sight</span><span class="o">.</span><span class="na">setDetail</span><span class="o">(</span><span class="k">new</span> <span class="nc">SightDetail</span><span class="o">(</span><span class="s">"오전9시~오후5시"</span><span class="o">,</span> <span class="s">"연중무휴"</span><span class="o">,</span> <span class="s">"10대 주차가능"</span><span class="o">));</span>
  <span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">transaction</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
  <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
<span class="o">}</span><span class="k">finally</span><span class="o">{</span>
  <span class="n">entityManager</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>위 코드에서 entityManager.find()로 얻어온 객체는 <code class="language-plaintext highlighter-rouge">영속 객체</code>이다. 영속 객체는 <strong>DB에 보관된 데이터에 매핑되는 메모리상의 객체</strong> 를 의미한다. find() 메서드를 통해 읽어온 엔티티 객체는 DB에서 읽어온 객체이므로 영속 객체에 해당한다.</p><p>save()를 통해 새로운 객체를 추가하면 해당 객체는 영속 객체가 되고 EntityManager가 관리한다. 그리고 트랜잭션 커밋 시점에 영속 객체를 DB에 반영한다.</p><p>EntityManager는 영속 객체를 관리할 때 영속 컨텍스트라는 집합을 사용한다. 일종의 메모리 저장소로 EntityManager가 관리하는 엔티티 객체를 보관한다. DB에서 읽어온 엔티티 객체를 영속 컨텍스트에 보관하고 save()로 저장한 엔티티 객체 역시 영속 컨텍스트에 보관한다.</p><p><code class="language-plaintext highlighter-rouge">EntityManager는 트랜잭션 커밋 시점에 영속 컨텍스트에 보관된 영속 객체의 변경 내용을 추적해서 DB에 반영한다. 데이터가 변경된 객체는 update 쿼리를 이용해서 변경하고, 새롭게 추가된 객체는 insert 쿼리를 이용해 삽입, 삭제된 객체는 delete 쿼리를 이용해서 삭제한다.</code></p><p>JPA는 영속 컨텍스트에 보관한 엔티티를 구분할 때 식별자를 이용한다. 즉 <strong>영속 컨텍스트는 엔티티 타입+식별자를 키로 사용하고 엔티티를 값으로 사용하는 데이터 구조를 갖는다.</strong></p><h3 id="11-영속-컨텍스트와-캐시"><span class="mr-2">1.1 영속 컨텍스트와 캐시</span><a href="#11-영속-컨텍스트와-캐시" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>EntityManager 입장에서 영속 컨텍스트는 동일 식별자를 갖는 엔티티에 대한 캐시 역할을 한다.</p><p>예를 들어 한 EntityManager에서 객체에 대해 동일한 식별자를 갖는 엔티티를 두 번 이상 조회하면 첫 번째 find()에서는 select 쿼리를 실행하지만 두 번째 find()에서는 select 쿼리를 실행하지 않는다.(영속 컨텍스트에 보관된 객체를 리턴)</p><p>이 캐시는 영속 컨텍스트와 관련되어 있으므로 EntityManager 객체를 종료하기 전까지만 유효하다.</p><h2 id="02-entitymanager의-종류"><span class="mr-2">02. EntityManager의 종류</span><a href="#02-entitymanager의-종류" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>1)애플리케이션 관리 EntityManager</strong></p><p>애플리케이션 관리 EntityManager는 EntityManagerFactory 생성과 종료, 이를 이용하여 EntityManager를 생성하고 종료를 처리한다. 애플리케이션 코드에서 EntityManager의 생성과 종료를 책임지므로 EntityManager를 사용한 뒤에는 close()를 호출해서 EntityManager를 반드시 종료시켜야 한다.</p><p><strong>2)컨테이너 관리 EntityManager</strong></p><p>컨테이너 관리 EntityManager는 JEE 컨테이너에서 EntityManagerFactory와 EntityManager의 라이프사이클을 관리한다. JEE 컨테이너가 EntityManager를 생성하고 종료하는 과정을 처리하기 때문에 애플리케이션 코드는 컨테이너가 제공하는 EntityManager를 사용해서 필요한 기능만 구현하면 된다. EntityManager는 @PersistenceContext 애노테이션을 사용하면 된다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WithdrawService</span> <span class="o">{</span>
  <span class="c1">//JEE 컨테이너는 @PersistenceContext 애노테이션이 적용된 필드에 컨테이너가 관리하는 EntityManager 객체를 주입한다.</span>
  <span class="nd">@PersistenceContext</span>
  <span class="nc">EntityManager</span> <span class="n">em</span><span class="o">;</span>

  <span class="c1">//EntityManager가 트랜잭션에 참여하기 때문에 애플리케이션 코드에서는 트랜잭션을 직접 관리하지 않는다.</span>
  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">UserNotFoundException</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">em</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//컨테이너 관리 EntityManager에 대해 close()를 실행하면 에러가 발생한다.</span>
</pre></table></code></div></div><h2 id="03-트랜잭션-타입"><span class="mr-2">03. 트랜잭션 타입</span><a href="#03-트랜잭션-타입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="31-자원-로컬-트랜잭션-타입"><span class="mr-2">3.1 자원 로컬 트랜잭션 타입</span><a href="#31-자원-로컬-트랜잭션-타입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>JPA가 제공하는 EntityTransaction을 이용하는 방식으로 이 타입을 사용하려면 persistence.xml 파일에 영속단위의 transaction-type을 RESOURCE_LOCAL로 지정하면 된다.</p><p>그리고 EntityTransaction을 이용하여 트랜잭션을 시작(begin())하고, 커밋(commit())한다. 트랜잭션 커밋 시점에 영속 컨텍스트로 추적한 변경 내역을 DB에 반영하기 때문에 트랜잭션 없이 엔티티 객체를 수정하는 경우 변경 내역이 DB에 저장되지 않는다.</p><h3 id="32-jta-트랜잭션-타입"><span class="mr-2">3.2 JTA 트랜잭션 타입</span><a href="#32-jta-트랜잭션-타입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>이 타입을 사용하려면 persistence.xml 파일에 영속단위의 transaction-type을 JTA로 지정하면 된다. 이 타입을 사용하면 JPA에서 트랜잭션을 관리하지 않는다. EntityManager를 JTA 트랜잭션에 참여시켜 트랜잭션을 관리한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nc">UserTransaction</span> <span class="n">utx</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserTransaction</span><span class="o">)</span> <span class="k">new</span> <span class="nc">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">"java:comp/UserTransaction"</span><span class="o">);</span>
<span class="n">utx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>

<span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">joinTransaction</span><span class="o">();</span> <span class="c1">//JTA 트랜잭션에 참여한다.</span>

<span class="k">try</span><span class="o">{</span>
  <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
  <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">UserNotFoundException</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="n">em</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
  <span class="n">utx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span><span class="o">{</span>
    <span class="n">utx</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
  <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">SystemException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
<span class="o">}</span><span class="k">finally</span><span class="o">{</span>
  <span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>컨테이너 관리 EntityManager는 반드시 JTA 트랜잭션 타입을 사용해야 한다. 명시적으로 joinTransaction를 사용하지 않아도 JTA 트랜잭션 시작 이후 EntityManager를 생성하면 자동으로 트랜잭션에 참여한다.</p><h2 id="04-entitymanager의-영속-컨텍스트-전파"><span class="mr-2">04. EntityManager의 영속 컨텍스트 전파</span><a href="#04-entitymanager의-영속-컨텍스트-전파" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>보통 서비스는 트랜잭션을 관리하는 주체가 된다. 즉 서비스 메서드의 시작 시점에 트랜잭션을 시작하고 서비스 메서드의 종료 시점에 트랜잭션을 커밋한다.</p><p>엔티티를 수정하는 경우 find()메서드와 save()메서드가 사용하는 EntityManager는 같은 메서드에서 생성한 EntityManager와 같아야 한다. 서로 다른 EntityManager를 사용하는 경우 영속 컨텍스트와 트랜잭션을 공유하지 않으므로 원하는 쿼리가 실행되지 않는다.</p><p>EntityManager를 전파하는 가장 쉬운 방법은 find(), save() 메서드에 EntityManager 객체를 메서드 인자로 전달하는 것이다.</p><h3 id="41-threadlocal을-이용한-애플리케이션-관리-entitymanager의-전파"><span class="mr-2">4.1 ThreadLocal을 이용한 애플리케이션 관리 EntityManager의 전파</span><a href="#41-threadlocal을-이용한-애플리케이션-관리-entitymanager의-전파" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>ThreadLocal은 쓰레드 단위로 객체를 공유할 때 사용하는 클래스이다. 이 클래스를 사용하면 한 메서드에서 호출하는 메서드가 동일한 객체를 공유할 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EMF</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">EntityManagerFactory</span> <span class="n">emf</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">EntityManager</span><span class="o">&gt;</span> <span class="n">currentEm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span>

  <span class="c1">//.....</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">EntityManager</span> <span class="nf">currentEntityManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">currentEm</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">em</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
      <span class="n">currentEm</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">em</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">em</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">closeCurrentEntityManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">currentEm</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">em</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">currentEm</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
      <span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JoinService</span><span class="o">{</span>
  <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserRepository</span><span class="o">();</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="no">EMF</span><span class="o">.</span><span class="na">currentEntityManager</span><span class="o">();</span>
    <span class="k">try</span><span class="o">{</span>
      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
      <span class="nc">User</span> <span class="n">found</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
      <span class="k">if</span><span class="o">(</span><span class="n">found</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">DuplicateEmailException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
      <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="no">EMF</span><span class="o">.</span><span class="na">closeCurrentEntityManager</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepository</span><span class="o">{</span>
  <span class="kd">public</span> <span class="nc">User</span> <span class="nf">find</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="no">EMF</span><span class="o">.</span><span class="na">currentEntityManager</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="no">EMF</span><span class="o">.</span><span class="na">currentEntityManager</span><span class="o">();</span>
    <span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="no">EMF</span><span class="o">.</span><span class="na">currentEntityManager</span><span class="o">();</span>
    <span class="n">em</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">//.....</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="42-컨테이너-관리-entitymanager의-전파"><span class="mr-2">4.2 컨테이너 관리 EntityManager의 전파</span><a href="#42-컨테이너-관리-entitymanager의-전파" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>컨테이너 관리 EntityManager는 컨테이너가 알아서 EntityManager를 전파해준다. @PersistenceContext 애노테이션을 사용하면 현재 트랜잭션에 참여하는 EntityManager를 구할 수 있다.</p><p>컨테이너 관리 EntityManager는 항상 JTA 트랜잭션 타입을 사용해야 하므로 @PersistenceContext로 구한 EntityManager는 JTA를 이용한 글로벌 트랜잭션에 참여한다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/book/'>BOOK</a>, <a href='/categories/jpa-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EC%9E%85%EB%AC%B8/'>JPA 프로그래밍 입문</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/jpa/" class="post-tag no-text-decoration" >jpa</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >sql</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=5.+EntityManager%2C+%EC%98%81%EC%86%8D+%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8%2C+%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98+-+Hyeonsu+Lim&url=https%3A%2F%2Flimhyeonsu.github.io%2Fposts%2F05.EntityManager%2C%25EC%2598%2581%25EC%2586%258D%25EC%25BB%25A8%25ED%2585%258D%25EC%258A%25A4%25ED%258A%25B8%2C%25ED%258A%25B8%25EB%259E%259C%25EC%259E%25AD%25EC%2585%2598%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=5.+EntityManager%2C+%EC%98%81%EC%86%8D+%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8%2C+%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98+-+Hyeonsu+Lim&u=https%3A%2F%2Flimhyeonsu.github.io%2Fposts%2F05.EntityManager%2C%25EC%2598%2581%25EC%2586%258D%25EC%25BB%25A8%25ED%2585%258D%25EC%258A%25A4%25ED%258A%25B8%2C%25ED%258A%25B8%25EB%259E%259C%25EC%259E%25AD%25EC%2585%2598%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Flimhyeonsu.github.io%2Fposts%2F05.EntityManager%2C%25EC%2598%2581%25EC%2586%258D%25EC%25BB%25A8%25ED%2585%258D%25EC%258A%25A4%25ED%258A%25B8%2C%25ED%258A%25B8%25EB%259E%259C%25EC%259E%25AD%25EC%2585%2598%2F&text=5.+EntityManager%2C+%EC%98%81%EC%86%8D+%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8%2C+%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98+-+Hyeonsu+Lim" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div><script src="https://utteranc.es/client.js" repo="Limhyeonsu/Limhyeonsu.github.io" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/15.Top-N%EC%BF%BC%EB%A6%AC/">15. Top-N 쿼리</a><li><a href="/posts/09.%EB%A9%B4%EC%A0%91%EB%AC%B8%EC%A0%9C/">09. 면접문제</a><li><a href="/posts/14.%EB%B6%84%EC%84%9D%ED%95%A8%EC%88%98/">14. 분석함수</a><li><a href="/posts/07.%EA%B8%B0%EC%88%A0%EC%A0%81-%EB%AC%B8%EC%A0%9C/">07. 기술적 문제</a><li><a href="/posts/06.bigO/">06. big-O</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/software-engineering/">software_engineering</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/computer/">computer</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/http/">http</a> <a class="post-tag" href="/tags/infra/">infra</a> <a class="post-tag" href="/tags/tdd/">tdd</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/bufferedreader/">bufferedreader</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/02.JPA-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/"><div class="card-body"> <em class="timeago small" data-ts="1671108218" > 2022-12-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2. JPA 시작하기</h3><div class="text-muted small"><p> 01. 예제 프로젝트 02. 메이븐 프로젝트 생성 및 이클립스 임포트 03. 데이터베이스 생성 04. 모델 클래스와 매핑 설정 @Entity //1) @Table(name=&quot;user&quot;) //2) public class User { @Id //3) private String email; private String name; //4...</p></div></div></a></div><div class="card"> <a href="/posts/03.%EC%97%94%ED%8B%B0%ED%8B%B0/"><div class="card-body"> <em class="timeago small" data-ts="1671352838" > 2022-12-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>3. 엔티티</h3><div class="text-muted small"><p> 01. 엔티티 클래스 JPA에서 엔티티는 영속성을 가진 객체로서 가장 중요한 타입이다. JPA의 엔티티는 DB 테이블에 보관할 대상이 된다. EntityManager를 사용해서 엔티티 단위로 저장하고 조회하고 삭제한다. JPA는 두 가지 방법으로 엔티티를 설정하는데 1)@Entity 애노테이션을 사용하는 방법 2)XML 매핑 설정을 사용하는 방법이 ...</p></div></div></a></div><div class="card"> <a href="/posts/04.%EB%B0%B8%EB%A5%98%EC%99%80-@Embeddable/"><div class="card-body"> <em class="timeago small" data-ts="1671631332" > 2022-12-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>4. 밸류와 @Embeddable</h3><div class="text-muted small"><p> 01. 밸류로 의미 더 드러내기 Hotel 클래스는 주소 자체를 의미하는 address 데이터를 갖고 있다. 그리고 Address 클래스는 zipcode, address1, address2를 데이터로 갖고 있어 따로 유추하지 않아도 주소가 우편번호, 주소1, 주소2로 구성된다는 것을 알 수 있다. Address 클래스 같은 타입을 value라고 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/04.%EB%B0%B8%EB%A5%98%EC%99%80-@Embeddable/" class="btn btn-outline-primary" prompt="Older"><p>4. 밸류와 @Embeddable</p></a> <a href="/posts/06.%EC%98%81%EC%86%8D-%EA%B0%9D%EC%B2%B4%EC%9D%98-%EB%9D%BC%EC%9D%B4%ED%94%84%EC%82%AC%EC%9D%B4%ED%81%B4/" class="btn btn-outline-primary" prompt="Newer"><p>6. 영속 객체의 라이프사이클</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/imhyeon99494867">Lim Hyeonsu</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/software-engineering/">software_engineering</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/computer/">computer</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/http/">http</a> <a class="post-tag" href="/tags/infra/">infra</a> <a class="post-tag" href="/tags/tdd/">tdd</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/bufferedreader/">bufferedreader</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
